<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suply BLE Scanner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #050917;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px 60px;
            text-align: center;
        }

        .container {
            background: #111b3e;
            padding: 2.5rem;
            border-radius: 30px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 1100px;
            text-align: left;
        }

        .logo {
            text-align: center;
            font-weight: 800;
            letter-spacing: 0.3rem;
            font-size: clamp(2.5rem, 6vw, 4rem);
            margin-bottom: 8px;
        }

        .logo span {
            color: #2fd2ff;
        }

        h1 { margin-bottom: 10px; font-size: 1.35rem; text-align: center; }
        p { color: #a9a9c9; margin-bottom: 30px; line-height: 1.5; text-align: center; }

        #action-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s, opacity 0.2s;
            color: white;
            box-sizing: border-box;
        }
        .btn:active { transform: scale(0.98); }

        .btn-ble {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }
        .btn-play { background-color: #01875f; }
        .btn-ios { background-color: #007aff; }
        .btn-apk { background-color: #34495e; border: 1px solid #555; }
        
        .icon { margin-right: 10px; font-size: 1.2rem; }

        .card {
            background: #0f162b;
            border: 1px solid #1f2a44;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 20px;
            width: 100%;
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: 14px;
            font-size: 1.2rem;
        }

        .grid {
            display: grid;
            gap: 12px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.08);
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.85rem;
        }

        .status-pill span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #283352;
            background: #0d1324;
            color: white;
            box-sizing: border-box;
        }

        label {
            font-size: 0.85rem;
            color: #9ca8d9;
            margin-bottom: 6px;
            display: inline-block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        th {
            background: rgba(255,255,255,0.05);
            position: sticky;
            top: 0;
        }

        .scroll-area {
            max-height: 320px;
            overflow-y: auto;
        }

        .log-area {
            font-family: monospace;
            font-size: 0.75rem;
            background: #0f1526;
            border-radius: 10px;
            padding: 12px;
            max-height: 260px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 6px;
        }

        .log-entry span {
            color: #a9a9c9;
            margin-right: 6px;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(255,255,255,0.08);
        }

        .toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle input {
            width: auto;
        }

        .actions-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }

        .metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .metric-card {
            flex: 1;
            min-width: 140px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 14px;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #9ca8d9;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .upload-config {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .section-title {
            font-size: 1rem;
            margin: 0 0 8px 0;
            color: #c4c9f1;
        }
    </style>
</head>
<body>

    <div>
        <div class="logo" translate="no" aria-label="SUPLY logo">SUPLY.</div>
        <h1 id="header-text">Suply BLE Device Scanner</h1>
        <p id="sub-text">Connect to Suply Echo / BT03 loggers, extract sensor data, and upload directly to Suply.</p>

        <div class="card">
            <div class="grid grid-2">
                <div class="status-pill">
                    <span id="secure-indicator"></span>
                    Secure Context Required (HTTPS / localhost)
                </div>
                <div class="status-pill">
                    <span id="ble-indicator"></span>
                    Web Bluetooth Support
                </div>
            </div>
            <div class="metrics" style="margin-top:16px;">
                <div class="metric-card">
                    <div class="metric-label">Connection</div>
                    <div class="metric-value" id="connection-status">Idle</div>
                    <div class="metric-label" id="connection-device">No device</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Sensor Readings</div>
                    <div class="metric-value" id="reading-count">0</div>
                    <div class="metric-label" id="last-reading">‚Äì</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Raw Packets</div>
                    <div class="metric-value" id="packet-count">0</div>
                    <div class="metric-label" id="progress-info">0%</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Device Controls</h2>
            <div class="grid grid-2">
                <div>
                    <label for="device-id-input">Device ID (optional)</label>
                    <input id="device-id-input" type="text" placeholder="Enter device ID">
                </div>
                <div>
                    <label for="api-url-input">Suply API URL</label>
                    <input id="api-url-input" type="text" placeholder="https://api.suply.ai/api/v1">
                </div>
            </div>

            <div class="toggle" style="margin-top:16px;">
                <label>
                    <input type="checkbox" id="debug-mode-toggle">
                    Debug Mode (show all BLE devices)
                </label>
            </div>

            <div id="action-area">
                <button class="btn btn-ble" id="scan-btn">
                    <span class="icon">üîç</span>
                    Scan for Devices
                </button>
                <button class="btn btn-play" id="fetch-btn" disabled>
                    <span class="icon">üì•</span>
                    Fetch Sensor Data
                </button>
                <button class="btn btn-ios" id="upload-btn" disabled>
                    <span class="icon">‚òÅÔ∏è</span>
                    Upload to Suply
                </button>
                <button class="btn btn-apk" id="disconnect-btn" disabled>
                    <span class="icon">‚èèÔ∏è</span>
                    Disconnect
                </button>
            </div>

            <div class="actions-row">
                <button class="btn btn-apk" id="export-csv-btn" disabled>üìÑ Export CSV</button>
                <button class="btn btn-apk" id="export-raw-btn" disabled>üßæ Export Raw Data</button>
                <button class="btn btn-apk" id="clear-data-btn" disabled>üóëÔ∏è Clear Data</button>
            </div>
        </div>

        <div class="card">
            <h2>Device Information</h2>
            <div class="grid grid-2">
                <div>
                    <div class="badge">Name</div>
                    <div id="info-name">‚Äì</div>
                </div>
                <div>
                    <div class="badge">ID</div>
                    <div id="info-id">‚Äì</div>
                </div>
                <div>
                    <div class="badge">Encryption</div>
                    <div id="info-encryption">‚Äì</div>
                </div>
                <div>
                    <div class="badge">Status</div>
                    <div id="info-status">Disconnected</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Temperature Readings</h2>
            <div class="scroll-area">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Temperature (¬∞C)</th>
                            <th>Humidity (%)</th>
                        </tr>
                    </thead>
                    <tbody id="readings-body">
                        <tr><td colspan="3" style="text-align:center;color:#777;">No data yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h2>Activity Monitor</h2>
            <div class="log-area" id="debug-log">[Init] Ready to scan</div>
        </div>

        <div class="card">
            <h2>Upload Configuration</h2>
            <div class="upload-config">
                <div>
                    <label for="org-id-input">Organization ID (optional)</label>
                    <input id="org-id-input" type="text" placeholder="Organization ID">
                </div>
                <div>
                    <label for="user-id-input">User ID (optional)</label>
                    <input id="user-id-input" type="text" placeholder="User ID">
                </div>
            </div>
            <p style="font-size:0.8rem;color:#9ca8d9;margin-top:10px;">
                Uploads call <code>/ble/upload-scan-data</code> on the configured API URL. Ensure you are on HTTPS or localhost for Web Bluetooth.
            </p>
        </div>
    </div>

    <script>
        /* ===== DOM Shortcuts ===== */
        const dom = {
            header: document.getElementById('header-text'),
            sub: document.getElementById('sub-text'),
            log: document.getElementById('debug-log'),
            secureIndicator: document.getElementById('secure-indicator'),
            bleIndicator: document.getElementById('ble-indicator'),
            connectionStatus: document.getElementById('connection-status'),
            connectionDevice: document.getElementById('connection-device'),
            readingCount: document.getElementById('reading-count'),
            lastReading: document.getElementById('last-reading'),
            packetCount: document.getElementById('packet-count'),
            progressInfo: document.getElementById('progress-info'),
            infoName: document.getElementById('info-name'),
            infoId: document.getElementById('info-id'),
            infoEncryption: document.getElementById('info-encryption'),
            infoStatus: document.getElementById('info-status'),
            readingsBody: document.getElementById('readings-body'),
            scanBtn: document.getElementById('scan-btn'),
            fetchBtn: document.getElementById('fetch-btn'),
            uploadBtn: document.getElementById('upload-btn'),
            disconnectBtn: document.getElementById('disconnect-btn'),
            exportCsvBtn: document.getElementById('export-csv-btn'),
            exportRawBtn: document.getElementById('export-raw-btn'),
            clearDataBtn: document.getElementById('clear-data-btn'),
            debugToggle: document.getElementById('debug-mode-toggle'),
            deviceIdInput: document.getElementById('device-id-input'),
            apiUrlInput: document.getElementById('api-url-input'),
            orgIdInput: document.getElementById('org-id-input'),
            userIdInput: document.getElementById('user-id-input')
        };

        /* ===== Constants ===== */
        const BLE_SERVICE_UUID = '6c400001-b5a3-f393-e0a9-e50e24dcca9e';
        const BLE_CHARACTERISTICS = {
            RX: '6c400002-b5a3-f393-e0a9-e50e24dcca9e',
            TX: '6c400003-b5a3-f393-e0a9-e50e24dcca9e',
        };

        const COMMON_BLE_SERVICES = [
            '6c400001-b5a3-f393-e0a9-e50e24dcca9e',
            '6c400002-b5a3-f393-e0a9-e50e24dcca9e',
            '6c400003-b5a3-f393-e0a9-e50e24dcca9e',
            '00001800-0000-1000-8000-00805f9b34fb',
            '00001801-0000-1000-8000-00805f9b34fb',
            '0000180a-0000-1000-8000-00805f9b34fb',
            '0000180f-0000-1000-8000-00805f9b34fb',
            '49535343-fe7d-4ae5-8fa9-9fafd205e455',
            '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
            '0000fff0-0000-1000-8000-00805f9b34fb',
            '0000ffe0-0000-1000-8000-00805f9b34fb',
            '0000ffe1-0000-1000-8000-00805f9b34fb',
            '0000ffe5-0000-1000-8000-00805f9b34fb',
        ];

        const BT03_COMMANDS = {
            QUERY_ENCRYPTION: new Uint8Array([0x2A, 0x03, 0x72, 0x32, 0x23]),
            READ_DEVICE_ID: new Uint8Array([0x2A, 0x03, 0x72, 0x41, 0x23]),
            QUERY_DATA_TYPE: new Uint8Array([0x2A, 0x03, 0x6C, 0x04, 0x23]),
            EXTRACT_ALL_DATA: new Uint8Array([0x2A, 0x0D, 0x6C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x23]),
            START_DATA_TRANSMISSION: new Uint8Array([0x2A, 0x03, 0x6C, 0x01, 0x23]),
        };

        /* ===== State ===== */
        let state = {
            device: null,
            server: null,
            rxChar: null,
            txChar: null,
            isConnected: false,
            isScanning: false,
            isFetching: false,
            isUploading: false,
            debugMode: false,
            readings: [],
            rawPackets: [],
            consoleLogs: [],
            seenTimestamps: new Set(),
            sensorType: 0x01,
            deviceInfo: {
                deviceId: 'Unknown',
                isEncrypted: false
            }
        };

        /* ===== Utilities ===== */
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `<div class="log-entry"><span>[${timestamp}]</span>${type.toUpperCase()}: ${message}</div>`;
            dom.log.innerHTML = entry + dom.log.innerHTML;
            state.consoleLogs.unshift({ timestamp, type, message });
            if (state.consoleLogs.length > 500) state.consoleLogs.pop();
        }

        function setIndicator(indicator, ok) {
            indicator.style.background = ok ? '#00e676' : '#ff5252';
        }

        function setButtonsState() {
            dom.scanBtn.disabled = state.isScanning;
            dom.fetchBtn.disabled = !state.isConnected || state.isFetching;
            dom.uploadBtn.disabled = !state.isConnected || state.readings.length === 0 || state.isUploading;
            dom.disconnectBtn.disabled = !state.isConnected;
            dom.exportCsvBtn.disabled = state.readings.length === 0;
            dom.exportRawBtn.disabled = state.rawPackets.length === 0;
            dom.clearDataBtn.disabled = state.readings.length === 0 && state.rawPackets.length === 0;
        }

        function updateMetrics() {
            dom.connectionStatus.textContent = state.isConnected ? 'Connected' : 'Idle';
            dom.connectionDevice.textContent = state.device ? (state.device.name || 'Unknown device') : 'No device';
            dom.readingCount.textContent = state.readings.length;
            dom.packetCount.textContent = state.rawPackets.length;
            dom.progressInfo.textContent = state.rawPackets.length ? `${state.rawPackets.length} packets` : '0%';
            dom.lastReading.textContent = state.readings.length
                ? new Date(state.readings[state.readings.length - 1].timestamp).toLocaleString()
                : '‚Äì';
        }

        function renderTable() {
            if (!state.readings.length) {
                dom.readingsBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#777;">No data yet</td></tr>';
                return;
            }

            dom.readingsBody.innerHTML = state.readings.map(reading => `
                <tr>
                    <td>${new Date(reading.timestamp).toLocaleString()}</td>
                    <td>${reading.temperature.toFixed(2)}</td>
                    <td>${reading.humidity !== undefined ? reading.humidity.toFixed(2) : '-'}</td>
                </tr>
            `).join('');
        }

        function alertUser(message, isError = false) {
            dom.sub.textContent = message;
            dom.sub.style.color = isError ? '#ff8a80' : '#a9a9c9';
        }

        function ensureSecureContext() {
            const secure = window.isSecureContext;
            setIndicator(dom.secureIndicator, secure);
            if (!secure) {
                alertUser('Web Bluetooth requires HTTPS or localhost.', true);
                log('Insecure context detected. HTTPS required for Web Bluetooth.', 'error');
            }
            return secure;
        }

        function ensureBleSupport() {
            const supported = 'bluetooth' in navigator;
            setIndicator(dom.bleIndicator, supported);
            if (!supported) {
                alertUser('Web Bluetooth API not supported in this browser.', true);
                log('Web Bluetooth API not available.', 'error');
            }
            return supported;
        }

        /* ===== BLE Logic ===== */
        async function scanForDevice() {
            if (!ensureSecureContext() || !ensureBleSupport()) return;

            try {
                state.isScanning = true;
                setButtonsState();
                alertUser('Check browser popup to select a device...');
                log('Opening device selector...');

                const options = state.debugMode
                    ? { acceptAllDevices: true, optionalServices: COMMON_BLE_SERVICES }
                    : {
                        filters: [
                            { name: 'Suply Echo' },
                            { namePrefix: 'Suply' },
                            { namePrefix: 'BT' },
                            { namePrefix: 'Echo' }
                        ],
                        optionalServices: COMMON_BLE_SERVICES
                    };

                const bleDevice = await navigator.bluetooth.requestDevice(options);
                state.device = bleDevice;
                log(`Device selected: ${bleDevice.name || 'Unknown'} (${bleDevice.id})`);

                await connectToDevice();
            } catch (error) {
                log(`Scan cancelled or failed: ${error.message || error}`, 'warn');
                alertUser('Scan cancelled.');
            } finally {
                state.isScanning = false;
                setButtonsState();
            }
        }

        async function connectToDevice() {
            if (!state.device) return;

            try {
                alertUser('Connecting to device...');
                log('Connecting to GATT server...');

                state.server = await state.device.gatt.connect();
                dom.infoName.textContent = state.device.name || 'Unknown';
                dom.infoStatus.textContent = 'Connected';

                log('Connected. Discovering service...');
                const service = await state.server.getPrimaryService(BLE_SERVICE_UUID);
                state.rxChar = await service.getCharacteristic(BLE_CHARACTERISTICS.RX);
                state.txChar = await service.getCharacteristic(BLE_CHARACTERISTICS.TX);

                state.isConnected = true;
                dom.connectionStatus.textContent = 'Connected';
                dom.connectionDevice.textContent = state.device.name || 'Unknown device';
                dom.disconnectBtn.disabled = false;

                await queryDeviceInfo();

                alertUser('Device connected. Ready to fetch data.');
                log('Device ready. Use "Fetch Sensor Data" to download logs.');
            } catch (error) {
                log(`Connection error: ${error.message || error}`, 'error');
                alertUser('Failed to connect. Check console for details.', true);
                state.isConnected = false;
                dom.infoStatus.textContent = 'Disconnected';
            } finally {
                setButtonsState();
                updateMetrics();
            }
        }

        async function queryDeviceInfo() {
            if (!state.rxChar || !state.txChar) return;

            const sendCommand = (command, label) => {
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error(`Timeout waiting for ${label}`)), 4000);

                    const handler = event => {
                        clearTimeout(timeout);
                        state.txChar.removeEventListener('characteristicvaluechanged', handler);
                        resolve(event.target.value);
                    };

                    state.txChar.addEventListener('characteristicvaluechanged', handler);
                    state.txChar.startNotifications().then(() => state.rxChar.writeValue(command)).catch(reject);
                });
            };

            try {
                const enc = await sendCommand(BT03_COMMANDS.QUERY_ENCRYPTION, 'encryption');
                const status = enc.getUint8(3);
                state.deviceInfo.isEncrypted = status !== 0;
                dom.infoEncryption.textContent = status === 0 ? 'No' : 'Yes';

                const idResp = await sendCommand(BT03_COMMANDS.READ_DEVICE_ID, 'device ID');
                if (idResp.byteLength >= 12) {
                    const idBytes = [];
                    for (let i = 4; i < 8; i++) idBytes.push(idResp.getUint8(i).toString(16).padStart(2, '0'));
                    const deviceId = idBytes.join('').toUpperCase();
                    dom.infoId.textContent = deviceId;
                    state.deviceInfo.deviceId = deviceId;
                }
            } catch (error) {
                log(`Device info query failed: ${error.message || error}`, 'warn');
            }
        }

        async function fetchSensorData() {
            if (!state.rxChar || !state.txChar) return;

            try {
                state.isFetching = true;
                setButtonsState();
                alertUser('Fetching sensor data from device...');
                log('Starting sensor data download...');

                state.rawPackets = [];
                state.readings = [];
                state.seenTimestamps.clear();
                state.sensorType = 0x01;

                await state.txChar.startNotifications();

                const packets = [];
                state.txChar.addEventListener('characteristicvaluechanged', event => {
                    packets.push(event.target.value);
                });

                await state.rxChar.writeValue(BT03_COMMANDS.QUERY_DATA_TYPE);
                await delay(300);
                await state.rxChar.writeValue(BT03_COMMANDS.EXTRACT_ALL_DATA);
                await delay(500);
                await state.rxChar.writeValue(BT03_COMMANDS.START_DATA_TRANSMISSION);

                await delay(8000);

                state.rawPackets = packets.slice();
                parseDataPackets(packets);

                alertUser(`Fetched ${state.readings.length} readings from device.`);
                log(`Fetched ${state.readings.length} readings.`);
            } catch (error) {
                log(`Fetch error: ${error.message || error}`, 'error');
                alertUser('Failed to fetch data.', true);
            } finally {
                state.isFetching = false;
                setButtonsState();
            }
        }

        function parseDataPackets(packets) {
            const readings = [];
            const seen = new Set();

            const readInt16 = (view, offset) => {
                const value = view.getUint16(offset, true);
                const isNegative = (value & 0x8000) !== 0;
                const magnitude = value & 0x7FFF;
                return (isNegative ? -magnitude : magnitude) / 10;
            };

            packets.forEach((packet, index) => {
                const len = packet.getUint16(0, true);
                const type = packet.getUint8(2);

                if (type === 0x01) {
                    const dataLen = len - 1;
                    const recordSize = state.sensorType === 0x02 ? 8 : 6;
                    const count = Math.floor(dataLen / recordSize);

                    for (let i = 0; i < count; i++) {
                        const base = 3 + i * recordSize;
                        const timestamp = packet.getUint32(base, true);
                        const iso = new Date(timestamp * 1000).toISOString();
                        const temp = readInt16(packet, base + 4);
                        const humidity = state.sensorType === 0x02 ? readInt16(packet, base + 6) : undefined;

                        if (!seen.has(iso)) {
                            seen.add(iso);
                            readings.push({ timestamp: iso, temperature: temp, humidity });
                        }
                    }
                }

                if (type === 0x02) {
                    const dataLen = len - 1;
                    const recordSize = state.sensorType === 0x02 ? 4 : 2;
                    const baseTime = Date.now();

                    for (let i = 0; i < dataLen / recordSize; i++) {
                        const base = 3 + i * recordSize;
                        const temp = readInt16(packet, base);
                        const humidity = state.sensorType === 0x02 ? readInt16(packet, base + 2) : undefined;
                        const iso = new Date(baseTime + i * 1000).toISOString();
                        readings.push({ timestamp: iso, temperature: temp, humidity });
                    }
                }

                if (type === 0x03) {
                    const dataLen = len - 1 - 8;
                    const interval = packet.getUint32(7, true);
                    const startTimestamp = packet.getUint32(3, true);
                    const recordSize = state.sensorType === 0x02 ? 4 : 2;
                    const count = Math.floor(dataLen / recordSize);

                    for (let i = 0; i < count; i++) {
                        const base = 11 + i * recordSize;
                        const temp = readInt16(packet, base);
                        const humidity = state.sensorType === 0x02 ? readInt16(packet, base + 2) : undefined;
                        const ts = startTimestamp + i * interval;
                        const iso = new Date(ts * 1000).toISOString();
                        if (!seen.has(iso)) {
                            seen.add(iso);
                            readings.push({ timestamp: iso, temperature: temp, humidity });
                        }
                    }
                }
            });

            readings.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            state.readings = readings;
            renderTable();
            updateMetrics();
        }

        async function uploadData() {
            if (!state.readings.length) {
                alertUser('No data to upload.', true);
                return;
            }

            const apiUrl = dom.api-url-input?.value || dom.apiUrlInput.value || '';
            if (!apiUrl) {
                alertUser('Please provide an API URL.', true);
                return;
            }

            const payload = {
                deviceId: dom.deviceIdInput.value || state.deviceInfo.deviceId || 'Unknown',
                scanMethod: 'scany_html',
                temperatureReadings: state.readings,
                scannerMetadata: {
                    deviceName: state.device?.name || 'Unknown',
                    browser: navigator.userAgent,
                    timestamp: new Date().toISOString(),
                    debugMode: state.debugMode,
                },
                organizationId: dom.orgIdInput.value || undefined,
                userId: dom.userIdInput.value || undefined,
            };

            try {
                state.isUploading = true;
                setButtonsState();
                alertUser('Uploading data to Suply...');
                log('Uploading data to backend...');

                const response = await fetch(`${apiUrl.replace(/\/$/, '')}/ble/upload-scan-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Upload failed');

                alertUser(`Upload successful! Scan ID: ${result.data?.scanId || 'N/A'}`);
                log(`Upload successful. Scan ID: ${result.data?.scanId || 'N/A'}`);
            } catch (error) {
                alertUser(`Upload failed: ${error.message || error}`, true);
                log(`Upload error: ${error.message || error}`, 'error');
            } finally {
                state.isUploading = false;
                setButtonsState();
            }
        }

        function exportCSV() {
            if (!state.readings.length) return;

            const header = 'Timestamp,Temperature (¬∞C),Humidity (%)\n';
            const rows = state.readings.map(r => `${r.timestamp},${r.temperature},${r.humidity ?? ''}`).join('\n');
            downloadFile(header + rows, `suply-ble-${Date.now()}.csv`, 'text/csv');
        }

        function exportRaw() {
            if (!state.rawPackets.length) return;

            const payload = {
                metadata: {
                    device: state.device?.name || 'Unknown',
                    deviceId: state.deviceInfo.deviceId || 'Unknown',
                    exportedAt: new Date().toISOString(),
                    packets: state.rawPackets.length,
                    readings: state.readings.length,
                },
                packets: state.rawPackets.map((packet, i) => ({
                    index: i,
                    length: packet.byteLength,
                    type: packet.getUint8(2),
                    hex: Array.from(new Uint8Array(packet.buffer, packet.byteOffset, packet.byteLength))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join(' '),
                })),
            };

            downloadFile(JSON.stringify(payload, null, 2), `suply-ble-raw-${Date.now()}.json`, 'application/json');
        }

        function downloadFile(content, filename, mime) {
            const blob = new Blob([content], { type: mime });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function clearData() {
            state.readings = [];
            state.rawPackets = [];
            renderTable();
            updateMetrics();
            setButtonsState();
            alertUser('Cleared local data.');
            log('Cleared readings and packets.');
        }

        function delay(ms) {
            return new Promise(res => setTimeout(res, ms));
        }

        function disconnectDevice() {
            if (state.device?.gatt?.connected) {
                state.device.gatt.disconnect();
            }
            state.isConnected = false;
            dom.infoStatus.textContent = 'Disconnected';
            alertUser('Device disconnected.');
            log('Disconnected from device.');
            setButtonsState();
            updateMetrics();
        }

        /* ===== Event Listeners ===== */
        dom.scanBtn.addEventListener('click', scanForDevice);
        dom.fetchBtn.addEventListener('click', fetchSensorData);
        dom.uploadBtn.addEventListener('click', uploadData);
        dom.disconnectBtn.addEventListener('click', disconnectDevice);
        dom.exportCsvBtn.addEventListener('click', exportCSV);
        dom.exportRawBtn.addEventListener('click', exportRaw);
        dom.clearDataBtn.addEventListener('click', clearData);
        dom.debugToggle.addEventListener('change', e => {
            state.debugMode = e.target.checked;
            log(`Debug mode ${state.debugMode ? 'enabled' : 'disabled'}`);
        });

        document.addEventListener('DOMContentLoaded', () => {
            ensureSecureContext();
            ensureBleSupport();
            setButtonsState();
            updateMetrics();
        });
    </script>
</body>
</html>